<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2196f3;
      --primary-dark: #1769aa;
      --danger: #e53935;
      --surface: #fff;
      --surface-dark: #232946;
      --text: #222;
      --bg-gradient: linear-gradient(135deg, #fff3e6 70%, #ffe0b2 100%);
      --bg-gradient-dark: linear-gradient(135deg, #232946 0%, #2b3a67 100%);
      --shadow: 0 8px 36px rgba(33, 150, 243, 0.13), 0 4px 16px rgba(0,0,0,0.11);
    }
    [data-theme="dark"] {
      --surface: #191c20;
      --surface-dark: #232946;
      --text: #e8eaf6;
      --bg-gradient: var(--bg-gradient-dark);
      --shadow: 0 8px 36px rgba(37, 60, 89, 0.24), 0 4px 16px rgba(0,0,0,0.28);
    }
    html, body {
      font-family: 'Inter', Arial, sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      transition: background 0.4s;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 2rem 0;
    }
    .container {
      max-width: 400px;
      width: 97vw;
      margin: 2.5rem auto 1rem auto;
      background: var(--surface);
      padding: 2.2rem 1.4rem 1.7rem 1.4rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
      text-align: center;
      position: relative;
      animation: fadein 0.8s;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    @keyframes fadein {
      0% { opacity: 0; transform: translateY(22px) scale(.98);}
      100% { opacity: 1; transform: translateY(0) scale(1);}
    }
    .theme-toggle {
      position: absolute;
      top: 18px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.23rem;
      cursor: pointer;
      color: var(--primary-dark);
      outline: none;
      transition: color 0.2s;
    }
    .theme-toggle:focus { color: #ffda47; }
    h2 {
      color: var(--primary-dark);
      margin-bottom: 0.7em;
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 1.47em;
    }
    .profile-pic {
      width: 74px; height: 74px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e3f1fd, #b6d3ff 65%, #74ebd5 100%);
      margin: 0 auto 1em;
      display: flex; align-items: center; justify-content: center;
      font-size: 2.2em;
      box-shadow: 0 2px 10px #b6d3ff33;
      position: relative;
      transition: box-shadow 0.3s;
      overflow: hidden;
      cursor: pointer;
    }
    .profile-pic:hover {
      box-shadow: 0 4px 20px #74ebd544;
      filter: brightness(1.09);
    }
    .edit-pic-btn {
      position: absolute;
      bottom: 5px; right: 6px;
      background: var(--primary-dark);
      color: #fff;
      border-radius: 50%;
      border: none;
      width: 24px; height: 24px;
      font-size: 1.1em;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1px 6px #e3e8ee;
      cursor: pointer;
      transition: background 0.15s;
      z-index: 2;
    }
    .edit-pic-btn:hover { background: #2196f3;}
    .profile-list {
      text-align: left;
      width: 100%;
      margin: 1.2em 0 1.2em 0;
      padding: 0;
      list-style: none;
      border-radius: 10px;
      background: #f8fbff;
      box-shadow: 0 1px 7px #e3e8ee55;
      font-size: 1.03em;
    }
    .profile-list li {
      padding: 1em 1.2em;
      border-bottom: 1px solid #eef3f7;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .profile-list li:last-child { border-bottom: none; }
    [data-theme="dark"] .profile-list {
      background: #232946;
      color: #e8eaf6;
    }
    .profile-label {
      color: var(--primary-dark);
      font-weight: 600;
    }
    [data-theme="dark"] .profile-label {
      color: #74ebd5;
    }
    .editable {
      border-bottom: 1px dashed #aaa;
      min-width: 60px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .editable:focus {
      outline: 2px solid var(--primary);
      border-bottom: 1px solid var(--primary);
    }
    .profile-actions {
      margin-top: 1.1em;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }
    .profile-actions button {
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.85em 1.7em;
      font-size: 1em;
      font-weight: 600;
      box-shadow: 0 2px 8px #e3e8ee;
      cursor: pointer;
      transition: background 0.17s;
    }
    .profile-actions button:hover { background: #1769aa;}
    .danger-btn {
      background: var(--danger);
    }
    .danger-btn:hover { background: #ab000d;}
    .status-msg {
      margin: 1em auto 0.5em auto;
      color: #1769aa;
      font-size: 0.99em;
      min-height: 1.6em;
      text-align: center;
      font-weight: 500;
    }
    @media (max-width: 500px) { 
      .container { padding: 1rem 0.1rem; }
      .profile-list li { padding: 0.8em 0.6em; font-size: 0.97em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Toggle light/dark mode">üåô</button>
    <h2>Your Profile</h2>
    <div class="profile-pic" id="profilePic" title="Change profile picture">
      <span id="profileEmoji" style="pointer-events:none;">üë©‚Äç‚öïÔ∏è</span>
      <button class="edit-pic-btn" id="editPicBtn" title="Edit picture">&#9998;</button>
    </div>
    <ul class="profile-list">
      <li><span class="profile-label">Name:</span> <span class="editable" id="nameField" tabindex="0">Loading...</span></li>
      <li><span class="profile-label">Email:</span> <span class="editable" id="emailField" tabindex="0">Loading...</span></li>
      <li><span class="profile-label">Role:</span> <span id="roleField">Loading...</span></li>
    </ul>
    <div class="status-msg" id="statusMsg"></div>
    <div class="profile-actions">
      <button id="saveBtn" style="display:none;">Save Changes</button>
      <button class="danger-btn" id="deleteBtn">Delete Account</button>
      <button onclick="location.href='dashboard_counselor.html'">Back</button>
    </div>
  </div>
  <script>
    // THEME TOGGLE
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      themeToggle.textContent = theme === "dark" ? "üåû" : "üåô";
      localStorage.setItem('theme', theme);
    }
    themeToggle.onclick = () => {
      const curr = document.documentElement.getAttribute('data-theme');
      setTheme(curr === "dark" ? "light" : "dark");
    };
    (() => {
      let theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light");
      setTheme(theme);
    })();

    // Profile data interaction
    const API_URL = "http://localhost:8000";
    const userId = 1; // Replace with real user id if using auth/session
    const nameField = document.getElementById('nameField');
    const emailField = document.getElementById('emailField');
    const roleField = document.getElementById('roleField');
    const profileEmoji = document.getElementById('profileEmoji');
    const statusMsg = document.getElementById('statusMsg');
    const saveBtn = document.getElementById('saveBtn');
    let profileData = {};
    let isDirty = false;
    let emojiOptions = ["üë©‚Äç‚öïÔ∏è","üßë‚Äç‚öïÔ∏è","üë®‚Äç‚öïÔ∏è","ü¶∏‚Äç‚ôÄÔ∏è","üßë‚Äçüíª","üßë‚Äçüéì","ü¶∏‚Äç‚ôÇÔ∏è","üë©‚Äçüíº","üßò‚Äç‚ôÇÔ∏è","ü¶â","ü¶Ñ"];

// Get the current user's profile
async function getCurrentUserId() {
  const resp = await fetch(`${API_URL}/users/me`, { credentials: "include" });
  if (!resp.ok) throw new Error("Not logged in");
  const data = await resp.json();
  return data.id; // Use this ID for profile GET/PATCH
}
    // Fetch profile data from backend
    async function loadProfile() {
      statusMsg.textContent = "Loading profile...";
      try {
        const resp = await fetch(`${API_URL}/users/${userId}`);
        if (!resp.ok) throw new Error("Failed to fetch profile");
        profileData = await resp.json();
        nameField.textContent = profileData.name || "No name";
        emailField.textContent = profileData.email || "No email";
        roleField.textContent = profileData.role || "Counselor";
        profileEmoji.textContent = profileData.emoji || "üë©‚Äç‚öïÔ∏è";
        statusMsg.textContent = "";
      } catch (err) {
        statusMsg.textContent = "Error loading profile.";
        nameField.textContent = "Counselor Demo";
        emailField.textContent = "demo@yourapp.com";
        roleField.textContent = "Counselor";
        profileEmoji.textContent = "üë©‚Äç‚öïÔ∏è";
      }
    }

    // Make editable fields work
    [nameField, emailField].forEach(field => {
      field.addEventListener('click', () => {
        makeEditable(field);
      });
      field.addEventListener('keydown', (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          field.blur();
        }
      });
    });

    function makeEditable(field) {
      if (field.querySelector('input')) return;
      const oldValue = field.textContent;
      const input = document.createElement('input');
      input.type = "text";
      input.value = oldValue;
      input.style.fontSize = "1em";
      input.style.width = "86%";
      field.textContent = "";
      field.appendChild(input);
      input.focus();
      input.select();
      input.addEventListener('blur', () => {
        field.textContent = input.value || oldValue;
        checkDirty();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === "Enter") input.blur();
      });
    }

    function checkDirty() {
      isDirty =
        (nameField.textContent !== (profileData.name || "Counselor Demo")) ||
        (emailField.textContent !== (profileData.email || "demo@yourapp.com")) ||
        (profileEmoji.textContent !== (profileData.emoji || "üë©‚Äç‚öïÔ∏è"));
      saveBtn.style.display = isDirty ? "" : "none";
      statusMsg.textContent = isDirty ? "You have unsaved changes." : "";
    }

    // Emoji profile picture picker
    document.getElementById('editPicBtn').onclick = () => {
      let opt = prompt("Choose your emoji avatar:\n" + emojiOptions.join(" "));
      if (opt && emojiOptions.includes(opt.trim())) {
        profileEmoji.textContent = opt.trim();
        checkDirty();
      } else if (opt) {
        alert("Please choose one of the suggested emojis.");
      }
    };

    // Save changes - PATCH instead of PUT!
    saveBtn.onclick = async () => {
      saveBtn.disabled = true;
      statusMsg.textContent = "Saving...";
      const updated = {
        name: nameField.textContent.trim(),
        email: emailField.textContent.trim(),
        emoji: profileEmoji.textContent
      };
      try {
        const resp = await fetch(`${API_URL}/users/${userId}`, {
          method: "PATCH", // PATCH for partial update
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(updated)
        });
        if (!resp.ok) {
          let errText = "Error saving profile.";
          try {
            const errJson = await resp.json();
            errText = errJson.detail || JSON.stringify(errJson);
          } catch {}
          throw new Error(errText);
        }
        statusMsg.textContent = "Profile updated!";
        isDirty = false;
        saveBtn.style.display = "none";
        await loadProfile();
      } catch (err) {
        statusMsg.textContent = err.message || "Error saving profile.";
      }
      saveBtn.disabled = false;
    };

    // Delete account (demo only)
    document.getElementById('deleteBtn').onclick = () => {
      if (confirm("Are you sure you want to delete your account? This cannot be undone.")) {
        alert("Account deletion is not implemented in this demo.");
      }
    };

    // Watch for changes to show save button
    [nameField, emailField].forEach(field => {
      field.addEventListener('input', checkDirty);
    });
    profileEmoji.addEventListener('DOMSubtreeModified', checkDirty);

    // Initial load
    loadProfile();
  </script>
</body>
</html>